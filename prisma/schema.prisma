generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  CUSTOMER
  MANAGER
  ADMIN
  SUPPORT
}

enum ProductUnit {
  PIECE
  METER
}

enum DeliveryType {
  PICKUP
  DELIVERY
}

enum PaymentMethod {
  CASH
  CARD
  ONLINE
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum OrderStatus {
  PENDING
  PROCESSING
  DELIVERING
  COMPLETED
  CANCELLED
}

enum SupportChatStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}

enum MessageSender {
  USER
  SUPPORT
  SYSTEM
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String

  name     String
  surname  String
  company  String?
  position String?
  city     String
  phone    String

  role     UserRole @default(CUSTOMER)
  isActive Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders       Order[]
  supportChats SupportChat[]
  supportMessages SupportMessage[]
  sessions Session[]

  @@map("users")
}

model Category {
  id        String  @id @default(uuid())
  key       String  @unique
  nameRu    String
  nameUz    String
  nameEn    String
  icon      String?
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@map("categories")
}

model Product {
  id   String @id @default(uuid())
  type String
  unit ProductUnit @default(PIECE)

  nameRu String
  nameUz String
  nameEn String

  descRu String @db.Text
  descUz String @db.Text
  descEn String @db.Text

  price Decimal @db.Decimal(12, 2)

  images          String[]
  sizes           String[]
  colors          String[]
  characteristics Json?

  stock      Int     @default(0)
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)
  sortOrder  Int     @default(0)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderItems OrderItem[]

  @@index([categoryId])
  @@index([type])
  @@index([unit])
  @@index([isActive])
  @@map("products")
}

model Session {
  id String @id @default(uuid())

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  refreshTokenHash String @unique
  expiresAt        DateTime
  revokedAt        DateTime?
  replacedBySessionId String?

  ip        String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model Order {
  id      String @id @default(uuid())
  shortId String @unique

  userId String
  user   User @relation(fields: [userId], references: [id])

  customerName  String
  customerPhone String
  customerEmail String

  deliveryType    DeliveryType
  branchKey       String?
  branchName      String?
  branchAddress   String?
  deliveryAddress String?

  paymentMethod PaymentMethod
  paymentStatus PaymentStatus @default(PENDING)

  status OrderStatus @default(PENDING)

  subtotal    Decimal @db.Decimal(12, 2)
  deliveryFee Decimal @db.Decimal(12, 2) @default(0)
  total       Decimal @db.Decimal(12, 2)

  notes      String? @db.Text
  adminNotes String? @db.Text

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  items OrderItem[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id String @id @default(uuid())

  orderId String
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  productName  Json
  productImage String

  quantity Int
  meters   Decimal? @db.Decimal(10, 2)
  size     String?
  color    String?

  pricePerUnit Decimal @db.Decimal(12, 2)
  total        Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())

  @@index([orderId])
  @@map("order_items")
}

model SupportChat {
  id String @id @default(uuid())

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  status     SupportChatStatus @default(OPEN)
  assignedTo String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  closedAt  DateTime?

  messages SupportMessage[]

  @@index([userId])
  @@index([status])
  @@map("support_chats")
}

model SupportMessage {
  id String @id @default(uuid())

  chatId String
  chat   SupportChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  userId String
  user   User @relation(fields: [userId], references: [id])

  sender MessageSender
  text   String @db.Text
  isRead Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([chatId])
  @@map("support_messages")
}

model Shop {
  id  String @id @default(uuid())
  key String @unique

  cityRu String
  cityUz String
  cityEn String

  addressRu String
  addressUz String
  addressEn String

  phone      String
  cardNumber String?

  latitude  Decimal? @db.Decimal(10, 7)
  longitude Decimal? @db.Decimal(10, 7)
  workHours String

  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("shops")
}
